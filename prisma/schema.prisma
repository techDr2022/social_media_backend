generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  name           String?
  plan           String          @default("free")
  createdAt      DateTime        @default(now())
  scheduledPosts ScheduledPost[]
  socialAccounts SocialAccount[]
  subscriptions  Subscription[]
  alerts         Alert[]
  gmbLocations   GmbLocation[]
  gmbPosts       GmbPost[]
  gmbReviews     GmbReview[]
}

model SocialAccount {
  id             String          @id @default(uuid())
  userId         String
  platform       String
  accountType    String?
  externalId     String
  displayName    String?
  username       String?
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  scopes         String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  scheduledPosts ScheduledPost[]
  user           User            @relation(fields: [userId], references: [id])

  // ⭐ Optimized indexes for common queries
  @@index([userId, platform]) // User + platform queries
  @@index([isActive, tokenExpiresAt]) // For token refresh queries
  @@index([platform, isActive]) // Platform-specific active accounts
  @@index([userId]) // User queries
}

model ScheduledPost {
  id              String        @id @default(uuid())
  userId          String
  socialAccountId String
  platform        String
  type            String        @default("post")
  content         String
  mediaUrl        String?
  scheduledAt     DateTime
  timezone        String?
  status          String        @default("pending")
  errorMessage    String?
  externalPostId  String?       // Instagram/Facebook post ID (e.g., "17924266338209280")
  permalink       String?       // Full URL to the post (e.g., "https://www.instagram.com/reel/DTU2zqgj8BK/")
  data            Json?         // Additional JSON data (container IDs, processing info, etc.)
  postedAt        DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  // ⭐ Optimized indexes for common queries
  @@index([userId, status, scheduledAt]) // Composite index for user queries
  @@index([platform, status]) // For platform-specific queries
  @@index([scheduledAt, status]) // For scheduler queries
  @@index([socialAccountId, status]) // For account queries
  @@index([status]) // For status filtering
}

model Plan {
  id                        String         @id @default(uuid())
  name                      String         @unique
  maxSocialAccounts         Int
  maxScheduledPostsPerMonth Int
  priceMonthly              Int
  createdAt                 DateTime       @default(now())
  subscriptions             Subscription[]
}

model Subscription {
  id                 String   @id @default(uuid())
  userId             String
  planId             String
  status             String   @default("active")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  externalCustomerId String?
  externalSubId      String?
  plan               Plan     @relation(fields: [planId], references: [id])
  user               User     @relation(fields: [userId], references: [id])
}

model Log {
  id          String   @id @default(uuid())
  level       String   // 'info', 'warn', 'error', 'debug'
  service     String   // 'instagram', 'facebook', 'youtube', etc.
  message     String
  method      String?  // HTTP method: GET, POST, PUT, DELETE, etc.
  path        String?  // Request path/endpoint
  ipaddress   String?  // Client IP address
  useragent   String?  @db.Text // User agent/browser info
  screensize  String?  // Screen size if available (widthxheight)
  requestdata String?  @db.Text // Request body/data as JSON
  responsedata String? @db.Text // Response data as JSON
  statuscode  Int?     // HTTP status code
  responsetime Int?    // Response time in milliseconds
  details     String?  @db.Text // Additional details as JSON
  userid      String?  // Optional user ID if available
  accountid   String?  // Optional social account ID
  errorstack  String?  @db.Text // Error stack trace if error
  createdat   DateTime @default(now())

  @@index([createdat])
  @@index([level])
  @@index([service])
  @@index([userid])
  @@index([method])
  @@index([path])
  @@index([statuscode])
}

model Alert {
  id              String        @id @default(uuid())
  userId          String
  socialAccountId String?
  scheduledPostId String?       // Link to the scheduled post
  type            String        // 'scheduled', 'processing', 'success', 'failed'
  platform        String        // 'instagram', 'facebook', 'youtube', 'gmb'
  title           String        // Alert title (e.g., "Post Scheduled")
  message         String        // Alert message (e.g., "Your photo post for @accountname is scheduled for Feb 5, 2026 at 3:00 PM")
  accountName     String?       // Display name of the social account
  postType        String?       // 'photo', 'video', 'carousel'
  scheduledAt     DateTime?     // When the post is scheduled for
  isRead          Boolean       @default(false)
  createdAt       DateTime      @default(now())
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ⭐ Optimized indexes for common queries
  @@index([userId, isRead, createdAt]) // For user's unread alerts, newest first
  @@index([userId, createdAt]) // For user's all alerts, newest first
  @@index([isRead]) // For bulk read operations
  @@index([type]) // For filtering by type
}

// Google My Business Models
model GmbLocation {
  id              String      @id @default(uuid())
  userId          String
  socialAccountId String?     // Link to the GMB account that owns this location (nullable for migration)
  gmbLocationId   String      // Maps to GBP locationId (e.g., from API)
  name            String      // Location name (e.g., "Store #1")
  phoneNumber     String?     // Optional phone number from GBP
  accountName     String?     // Account name from GMB
  address         String?     // Store address
  posts           GmbPost[]   // Relation to scheduled posts
  reviews         GmbReview[] // Relation to reviews
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([socialAccountId])
  @@index([gmbLocationId])
  @@index([socialAccountId, gmbLocationId]) // Index for unique constraint (will be unique per account after migration)
}

model GmbPost {
  id          String      @id @default(uuid())
  userId      String
  locationId  String
  location    GmbLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  content     String      // Post text
  imageUrl    String?     // Optional image URL
  videoUrl    String?     // Optional video URL
  scheduledAt DateTime    // When to post
  status      String      @default("scheduled") // scheduled, posted, failed
  ctaType     String?     // LEARN_MORE, BOOK, ORDER, BUY, SIGN_UP, CALL
  ctaUrl      String?     // Call-to-action URL
  externalPostId String?  // GMB post ID from API
  searchUrl      String?  // Link to view post on Google (from API)
  errorMessage   String?  // Error message if failed
  postedAt    DateTime?   // When actually posted
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@index([status])
  @@index([scheduledAt])
  @@index([userId])
}

model GmbReview {
  id          String      @id @default(uuid())
  userId      String
  gmbReviewId String      @unique // Maps to GBP reviewId (e.g., "A123")
  name        String?     // Name of the reviewer
  locationId  String
  location    GmbLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  comment     String?     // Review text (optional)
  rating      Int         // 1-5 stars
  responded   Boolean     @default(false) // Has a reply been posted?
  reply       String?     // AI-generated reply
  externalReviewId String? // External review ID from GMB API
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@index([gmbReviewId])
  @@index([userId])
  @@index([responded])
}
